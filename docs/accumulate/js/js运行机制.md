# js运行机制

<http://www.ruanyifeng.com/blog/2014/10/event-loop.html>

### javascript是单线程
主要是因为js主要做的是与用户交互的东西，以及操作DOM。如果说多线程的话，当一个线程在添加某个东西，另一个线程在删除这个东西，此时应该听谁的？所以是为了避免复杂性。  
<br/>
<table>
  <tr>
    <td bgcolor='pink'>
      <b>
        为了利用多核CPU的计算能力，HTML5提出Web Worker标准，允许JavaScript脚本创建多个线程，但是子线程完全受主线程控制，且不得操作DOM。所以，这个新标准并没有改变JavaScript单线程的本质。
      </b>
    </td>
  </tr>
</table>

### 主线程，任务队列
- <b>同步任务：</b>  
    在主线程上排队执行的任务。  

- <b>异步任务：</b>  
    不进入主线程，进入任务队列，只有“任务队列”通知主线程，某个异步任务可以执行了，该任务才会进入主线程执行。

#### 任务执行过程  

（1）所有同步任务都在主线程上执行，形成一个执行栈（execution context stack）。  
<br>
（2）主线程之外，还存在一个"任务队列"（task queue）。<font color="red">只要异步任务有了运行结果，</font>就在"任务队列"之中放置一个事件。<font color="red">（异步任务运行有结果后才会放置一个事件）</font>  
<br>
（3）一旦"执行栈"中的所有同步任务执行完毕，系统就会读取"任务队列"，看看里面有哪些事件。那些对应的异步任务，于是结束等待状态，进入执行栈，开始执行。  
<br>
（4）主线程不断重复上面的第三步。  


<table>
  <tr>
    <td bgcolor='pink'>
      <b>总结:</b>  
        只要主线程空了，就会去读取"任务队列"，这就是JavaScript的运行机制。这个过程会不断重复。
    </td>
  </tr>
</table>

### 重要：
"任务队列"是一个先进先出的数据结构，排在前面的事件，优先被主线程读取。主线程的读取过程基本上是自动的，只要执行栈一清空，"任务队列"上第一位的事件就自动进入主线程。但是，由于存在后文提到的"定时器"功能，主线程首先要检查一下执行时间，某些事件只有到了规定的时间，才能返回主线程。